<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Application de gestion de devis et factures pour chauffeurs VTC">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VTC Gestion">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect fill='%233b82f6' width='200' height='200' rx='40'/%3E%3Ctext x='100' y='120' font-size='100' text-anchor='middle' fill='white' font-family='Arial'%3Eüöó%3C/text%3E%3C/svg%3E">
    <title>Gestion Devis & Factures VTC</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .tabs { display: flex; background: #f5f5f5; border-bottom: 2px solid #ddd; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; background: #f5f5f5; border: none; font-size: 16px; font-weight: 600; transition: all 0.3s; }
        .tab:hover { background: #e0e0e0; }
        .tab.active { background: white; color: #3b82f6; border-bottom: 3px solid #3b82f6; }
        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        input, textarea, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: border 0.3s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #3b82f6; }
        textarea { resize: vertical; min-height: 80px; }
        .btn { padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-right: 10px; margin-bottom: 10px; }
        .btn-primary { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4); }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .course-section { background: #f0f9ff; padding: 25px; border-radius: 10px; margin: 20px 0; border: 2px solid #3b82f6; }
        .course-section h3 { color: #1e3a8a; margin-bottom: 20px; }
        .price-breakdown { background: #f9fafb; padding: 20px; border-radius: 8px; margin-top: 20px; border: 2px solid #e5e7eb; }
        .price-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e5e7eb; }
        .price-row:last-child { border-bottom: none; font-weight: 700; font-size: 1.3em; color: #1e3a8a; border-top: 2px solid #1e3a8a; margin-top: 10px; padding-top: 15px; }
        .list-item { background: white; padding: 20px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .list-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .list-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .list-item-title { font-size: 18px; font-weight: 600; color: #333; }
        .badge { display: inline-block; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-right: 10px; }
        .badge-devis { background: #dbeafe; color: #1e40af; }
        .badge-facture { background: #d1fae5; color: #065f46; }
        .course-details { background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .route-info { font-size: 15px; margin-bottom: 8px; }
        .company-info { background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e5e7eb; }
        .company-info h3 { color: #1e3a8a; margin-bottom: 15px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .supplement-row { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px; }
        .supplement-row input[type="checkbox"] { width: auto; }
        .supplement-row label { flex: 1; margin-bottom: 0; }
        .supplement-row input[type="number"] { width: 120px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Gestion VTC - Devis & Factures</h1>
            <p>Gestion professionnelle pour chauffeurs VTC</p>
            <button id="installButton" style="display: none; margin-top: 15px; padding: 10px 20px; background: white; color: #1e3a8a; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                üì± Installer l'application
            </button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('nouveau')">‚ûï Nouvelle Course</button>
            <button class="tab" onclick="showTab('liste')">üìã Mes Documents</button>
            <button class="tab" onclick="showTab('config')">‚öôÔ∏è Configuration</button>
        </div>

        <div class="content">
            <div id="nouveau" class="tab-content active">
                <h2 style="margin-bottom: 20px; color: #1e3a8a;">Cr√©er un nouveau document</h2>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Type de document</label>
                        <select id="docType">
                            <option value="devis">Devis</option>
                            <option value="facture">Facture</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="docDate">
                    </div>
                </div>
                <div class="form-group">
                    <label>Num√©ro</label>
                    <input type="text" id="docNumber" placeholder="Ex: VTC-2024-001">
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">üë§ Informations passager</h3>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Nom du passager *</label>
                        <input type="text" id="clientName" placeholder="Nom et pr√©nom">
                    </div>
                    <div class="form-group">
                        <label>T√©l√©phone</label>
                        <input type="tel" id="clientPhone" placeholder="+33 6 XX XX XX XX">
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="clientEmail" placeholder="email@exemple.fr">
                    </div>
                    <div class="form-group">
                        <label>Entreprise</label>
                        <input type="text" id="clientCompany" placeholder="Nom de l'entreprise">
                    </div>
                </div>

                <div class="course-section">
                    <h3>üó∫Ô∏è D√©tails de la course</h3>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Date de la course</label>
                            <input type="date" id="courseDate">
                        </div>
                        <div class="form-group">
                            <label>Heure de prise en charge</label>
                            <input type="time" id="courseTime">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Point de d√©part * <span style="color: #10b981; font-size: 12px;">üîç Autocompl√©tion activ√©e</span></label>
                        <input type="text" id="departureAddress" placeholder="Commencez √† taper l'adresse..." autocomplete="off">
                    </div>

                    <div class="form-group">
                        <label>Destination * <span style="color: #10b981; font-size: 12px;">üîç Autocompl√©tion activ√©e</span></label>
                        <input type="text" id="arrivalAddress" placeholder="Commencez √† taper l'adresse..." autocomplete="off">
                    </div>

                    <div class="grid-3">
                        <div class="form-group">
                            <label>Distance (km) <span style="color: #3b82f6; font-size: 12px;">‚ú® Calcul auto</span></label>
                            <input type="number" id="distance" step="0.1" min="0" placeholder="0.0" oninput="calculatePrice()">
                        </div>
                        <div class="form-group">
                            <label>Dur√©e estim√©e</label>
                            <input type="text" id="duration" placeholder="Ex: 45 min">
                        </div>
                        <div class="form-group">
                            <label>Nb passagers</label>
                            <input type="number" id="passengers" value="1" min="1" max="8">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Type de v√©hicule</label>
                        <select id="vehicleType" onchange="calculatePrice()">
                            <option value="berline">Berline standard</option>
                            <option value="berline-premium">Berline premium</option>
                            <option value="van">Van (6-8 places)</option>
                            <option value="luxe">V√©hicule de luxe</option>
                        </select>
                    </div>

                    <h4 style="margin-top: 20px; margin-bottom: 15px; color: #1e3a8a;">Suppl√©ments</h4>
                    
                    <div class="supplement-row">
                        <input type="checkbox" id="suppNight" onchange="calculatePrice()">
                        <label for="suppNight">Suppl√©ment nuit (20h-7h)</label>
                        <input type="number" id="suppNightAmount" value="10" step="0.01" min="0" oninput="calculatePrice()"> ‚Ç¨
                    </div>

                    <div class="supplement-row">
                        <input type="checkbox" id="suppAirport" onchange="calculatePrice()">
                        <label for="suppAirport">Suppl√©ment a√©roport</label>
                        <input type="number" id="suppAirportAmount" value="15" step="0.01" min="0" oninput="calculatePrice()"> ‚Ç¨
                    </div>

                    <div class="supplement-row">
                        <input type="checkbox" id="suppWaiting" onchange="calculatePrice()">
                        <label for="suppWaiting">Temps d'attente</label>
                        <input type="number" id="suppWaitingMinutes" value="0" min="0" placeholder="Minutes" oninput="calculatePrice()">
                        <span>min √†</span>
                        <input type="number" id="suppWaitingRate" value="0.50" step="0.01" min="0" oninput="calculatePrice()"> ‚Ç¨/min
                    </div>

                    <div class="supplement-row">
                        <input type="checkbox" id="suppBaggage" onchange="calculatePrice()">
                        <label for="suppBaggage">Suppl√©ment bagages</label>
                        <input type="number" id="suppBaggageAmount" value="5" step="0.01" min="0" oninput="calculatePrice()"> ‚Ç¨
                    </div>

                    <div class="supplement-row">
                        <input type="checkbox" id="suppToll" onchange="calculatePrice()">
                        <label for="suppToll">P√©ages</label>
                        <input type="number" id="suppTollAmount" value="0" step="0.01" min="0" oninput="calculatePrice()"> ‚Ç¨
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label>Remarques</label>
                        <textarea id="courseNotes" placeholder="Instructions particuli√®res..."></textarea>
                    </div>
                </div>

                <div class="price-breakdown">
                    <h3 style="margin-bottom: 15px; color: #1e3a8a;">üí∞ D√©tail du tarif</h3>
                    <div class="price-row">
                        <span>Prise en charge</span>
                        <span id="priceBase">0.00 ‚Ç¨</span>
                    </div>
                    <div class="price-row">
                        <span id="priceDistanceLabel">Distance (0 km)</span>
                        <span id="priceDistance">0.00 ‚Ç¨</span>
                    </div>
                    <div id="supplementsDetail"></div>
                    <div class="price-row">
                        <span>TOTAL TTC</span>
                        <span id="totalAmount">0.00 ‚Ç¨</span>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="saveDocument()">üíæ Enregistrer</button>
                    <button class="btn btn-secondary" onclick="resetForm()">üîÑ R√©initialiser</button>
                </div>
            </div>

            <div id="liste" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #1e3a8a;">Mes documents VTC</h2>
                <div id="documentsList"></div>
            </div>

            <div id="config" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #1e3a8a;">Configuration VTC</h2>
                
                <div class="company-info">
                    <h3>üè¢ Informations entreprise</h3>
                    <div class="form-group">
                        <label>Nom commercial</label>
                        <input type="text" id="companyName" placeholder="Ex: Inodico VTC">
                    </div>
                    <div class="form-group">
                        <label>Adresse</label>
                        <textarea id="companyAddress"></textarea>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>SIRET</label>
                            <input type="text" id="companySiret">
                        </div>
                        <div class="form-group">
                            <label>Licence VTC</label>
                            <input type="text" id="companyLicense">
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>T√©l√©phone</label>
                            <input type="text" id="companyPhone">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="companyEmail">
                        </div>
                    </div>
                </div>

                <div class="company-info">
                    <h3>üöó V√©hicule principal</h3>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Marque/Mod√®le</label>
                            <input type="text" id="vehicleBrand" placeholder="Ex: Mercedes Classe E">
                        </div>
                        <div class="form-group">
                            <label>Immatriculation</label>
                            <input type="text" id="vehiclePlate">
                        </div>
                        <div class="form-group">
                            <label>Couleur</label>
                            <input type="text" id="vehicleColor">
                        </div>
                    </div>
                </div>

                <div class="company-info" style="background: #d1fae5; border: 2px solid #10b981;">
                    <h3>üåç Syst√®me d'adresses - 100% Gratuit !</h3>
                    <p style="color: #065f46; margin-bottom: 10px;">
                        ‚úÖ <strong>Autocompl√©tion d'adresses</strong> : OpenStreetMap (Nominatim)<br>
                        ‚úÖ <strong>Calcul de distance et dur√©e</strong> : OSRM<br>
                        ‚úÖ Aucune inscription requise<br>
                        ‚úÖ Aucune carte bancaire<br>
                        ‚úÖ Aucune limite stricte
                    </p>
                </div>

                <div class="company-info">
                    <h3>üí∂ Tarification</h3>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Prise en charge (‚Ç¨)</label>
                            <input type="number" id="pricePickup" value="7" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label>Prix au km (‚Ç¨)</label>
                            <input type="number" id="pricePerKm" value="1.50" step="0.01" min="0">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveConfig()">üíæ Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let documents = JSON.parse(localStorage.getItem('vtc_documents')) || [];
        let config = JSON.parse(localStorage.getItem('vtc_config')) || {
            pricePickup: 7,
            pricePerKm: 1.50
        };

        let departureCoords = null;
        let arrivalCoords = null;
        let searchTimeout = null;

        // PWA - Enregistrement du service worker
        let deferredPrompt;

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker enregistr√©:', registration);
                    })
                    .catch(error => {
                        console.log('Erreur Service Worker:', error);
                    });
            });
        }

        // PWA - Gestion de l'√©v√©nement d'installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            const installButton = document.getElementById('installButton');
            if (installButton) {
                installButton.style.display = 'inline-block';
                
                installButton.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log(`Installation: ${outcome}`);
                        deferredPrompt = null;
                        installButton.style.display = 'none';
                    }
                });
            }
        });

        // PWA - D√©tection de l'installation r√©ussie
        window.addEventListener('appinstalled', () => {
            console.log('PWA install√©e avec succ√®s');
            deferredPrompt = null;
            const installButton = document.getElementById('installButton');
            if (installButton) {
                installButton.style.display = 'none';
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            document.getElementById('docDate').valueAsDate = new Date();
            document.getElementById('courseDate').valueAsDate = new Date();
            calculatePrice();
            updateDocumentsList();
            initAddressAutocomplete();
        });

        // Initialisation de l'autocompl√©tion avec OpenStreetMap
        function initAddressAutocomplete() {
            const departureInput = document.getElementById('departureAddress');
            const arrivalInput = document.getElementById('arrivalAddress');

            // Cr√©er les conteneurs pour les suggestions
            createSuggestionContainer(departureInput, 'departure');
            createSuggestionContainer(arrivalInput, 'arrival');

            // √âcouter les √©v√©nements de saisie
            departureInput.addEventListener('input', function() {
                handleAddressInput(this.value, 'departure');
            });

            arrivalInput.addEventListener('input', function() {
                handleAddressInput(this.value, 'arrival');
            });
        }

        function createSuggestionContainer(input, type) {
            const container = document.createElement('div');
            container.id = type + 'Suggestions';
            container.style.cssText = `
                position: absolute;
                background: white;
                border: 2px solid #3b82f6;
                border-top: none;
                border-radius: 0 0 8px 8px;
                max-height: 300px;
                overflow-y: auto;
                z-index: 1000;
                display: none;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                width: ${input.offsetWidth}px;
            `;
            input.parentNode.style.position = 'relative';
            input.parentNode.appendChild(container);
        }

        function handleAddressInput(query, type) {
            clearTimeout(searchTimeout);
            
            if (query.length < 3) {
                document.getElementById(type + 'Suggestions').style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                searchAddress(query, type);
            }, 300);
        }

        async function searchAddress(query, type) {
            try {
                // Utilisation de Nominatim (OpenStreetMap) pour la recherche d'adresses
                const url = `https://nominatim.openstreetmap.org/search?` + new URLSearchParams({
                    q: query,
                    format: 'json',
                    addressdetails: 1,
                    countrycodes: 'fr',
                    limit: 5
                });

                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'VTC-Management-App/1.0'
                    }
                });

                const results = await response.json();
                displaySuggestions(results, type);
            } catch (error) {
                console.error('Erreur lors de la recherche d\'adresse:', error);
            }
        }

        function displaySuggestions(results, type) {
            const container = document.getElementById(type + 'Suggestions');
            
            if (results.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.innerHTML = results.map(result => `
                <div style="padding: 12px; cursor: pointer; border-bottom: 1px solid #e5e7eb; transition: background 0.2s;"
                     onmouseover="this.style.background='#f0f9ff'"
                     onmouseout="this.style.background='white'"
                     onclick="selectAddress('${result.display_name.replace(/'/g, "\\'")}', ${result.lat}, ${result.lon}, '${type}')">
                    <div style="font-weight: 600; color: #1e3a8a;">${result.display_name.split(',')[0]}</div>
                    <div style="font-size: 12px; color: #666;">${result.display_name}</div>
                </div>
            `).join('');

            container.style.display = 'block';
        }

        function selectAddress(address, lat, lon, type) {
            document.getElementById(type + 'Address').value = address;
            document.getElementById(type + 'Suggestions').style.display = 'none';
            
            if (type === 'departure') {
                departureCoords = { lat, lon };
            } else {
                arrivalCoords = { lat, lon };
            }

            // Calculer la distance si les deux adresses sont s√©lectionn√©es
            if (departureCoords && arrivalCoords) {
                calculateDistance();
            }
        }

        async function calculateDistance() {
            if (!departureCoords || !arrivalCoords) {
                return;
            }

            try {
                // Utilisation d'OSRM pour le calcul de distance
                const url = `https://router.project-osrm.org/route/v1/driving/${departureCoords.lon},${departureCoords.lat};${arrivalCoords.lon},${arrivalCoords.lat}?overview=false`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.code === 'Ok' && data.routes.length > 0) {
                    const route = data.routes[0];
                    
                    // Distance en kilom√®tres
                    const distanceKm = (route.distance / 1000).toFixed(1);
                    document.getElementById('distance').value = distanceKm;
                    
                    // Dur√©e en minutes
                    const durationMin = Math.round(route.duration / 60);
                    document.getElementById('duration').value = durationMin + ' min';
                    
                    // Recalculer le prix
                    calculatePrice();
                }
            } catch (error) {
                console.error('Erreur lors du calcul de distance:', error);
            }
        }

        // Fermer les suggestions quand on clique ailleurs
        document.addEventListener('click', function(e) {
            if (!e.target.closest('[id$="Address"]')) {
                document.getElementById('departureSuggestions').style.display = 'none';
                document.getElementById('arrivalSuggestions').style.display = 'none';
            }
        });

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'liste') updateDocumentsList();
        }

        function calculatePrice() {
            const distance = parseFloat(document.getElementById('distance').value) || 0;
            const pickupPrice = parseFloat(config.pricePickup) || 7;
            const pricePerKm = parseFloat(config.pricePerKm) || 1.50;
            
            const basePrice = pickupPrice;
            const distancePrice = distance * pricePerKm;
            
            let supplements = [];
            let supplementsTotal = 0;
            
            if (document.getElementById('suppNight').checked) {
                const amount = parseFloat(document.getElementById('suppNightAmount').value) || 0;
                supplements.push({ name: 'Suppl√©ment nuit', amount });
                supplementsTotal += amount;
            }
            
            if (document.getElementById('suppAirport').checked) {
                const amount = parseFloat(document.getElementById('suppAirportAmount').value) || 0;
                supplements.push({ name: 'Suppl√©ment a√©roport', amount });
                supplementsTotal += amount;
            }
            
            if (document.getElementById('suppWaiting').checked) {
                const minutes = parseFloat(document.getElementById('suppWaitingMinutes').value) || 0;
                const rate = parseFloat(document.getElementById('suppWaitingRate').value) || 0;
                const amount = minutes * rate;
                supplements.push({ name: `Attente (${minutes} min)`, amount });
                supplementsTotal += amount;
            }
            
            if (document.getElementById('suppBaggage').checked) {
                const amount = parseFloat(document.getElementById('suppBaggageAmount').value) || 0;
                supplements.push({ name: 'Suppl√©ment bagages', amount });
                supplementsTotal += amount;
            }
            
            if (document.getElementById('suppToll').checked) {
                const amount = parseFloat(document.getElementById('suppTollAmount').value) || 0;
                supplements.push({ name: 'P√©ages', amount });
                supplementsTotal += amount;
            }
            
            const total = basePrice + distancePrice + supplementsTotal;
            
            document.getElementById('priceBase').textContent = basePrice.toFixed(2) + ' ‚Ç¨';
            document.getElementById('priceDistanceLabel').textContent = `Distance (${distance} km)`;
            document.getElementById('priceDistance').textContent = distancePrice.toFixed(2) + ' ‚Ç¨';
            
            const suppDetail = document.getElementById('supplementsDetail');
            suppDetail.innerHTML = supplements.map(s => 
                `<div class="price-row"><span>${s.name}</span><span>${s.amount.toFixed(2)} ‚Ç¨</span></div>`
            ).join('');
            
            document.getElementById('totalAmount').textContent = total.toFixed(2) + ' ‚Ç¨';
            
            return { basePrice, distancePrice, supplements, total };
        }

        function saveDocument() {
            const docType = document.getElementById('docType').value;
            const docNumber = document.getElementById('docNumber').value;
            const docDate = document.getElementById('docDate').value;
            const clientName = document.getElementById('clientName').value;
            const clientPhone = document.getElementById('clientPhone').value;
            const clientEmail = document.getElementById('clientEmail').value;
            const clientCompany = document.getElementById('clientCompany').value;
            const departure = document.getElementById('departureAddress').value;
            const arrival = document.getElementById('arrivalAddress').value;
            const courseDate = document.getElementById('courseDate').value;
            const courseTime = document.getElementById('courseTime').value;
            const distance = parseFloat(document.getElementById('distance').value) || 0;
            const duration = document.getElementById('duration').value;
            const passengers = document.getElementById('passengers').value;
            const vehicleType = document.getElementById('vehicleType').value;
            const courseNotes = document.getElementById('courseNotes').value;

            if (!docNumber || !clientName || !departure || !arrival) {
                alert('Veuillez remplir tous les champs obligatoires (*)');
                return;
            }

            const pricing = calculatePrice();
            
            const doc = {
                id: Date.now(),
                type: docType,
                number: docNumber,
                date: docDate,
                client: {
                    name: clientName,
                    phone: clientPhone,
                    email: clientEmail,
                    company: clientCompany
                },
                course: {
                    date: courseDate,
                    time: courseTime,
                    departure: departure,
                    arrival: arrival,
                    distance: distance,
                    duration: duration,
                    passengers: passengers,
                    vehicleType: vehicleType,
                    notes: courseNotes
                },
                pricing: pricing,
                createdAt: new Date().toISOString()
            };

            documents.push(doc);
            localStorage.setItem('vtc_documents', JSON.stringify(documents));
            alert('Document enregistr√© !');
            resetForm();
            showTab('liste');
            updateDocumentsList();
        }

        function resetForm() {
            document.getElementById('docNumber').value = '';
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('clientCompany').value = '';
            document.getElementById('departureAddress').value = '';
            document.getElementById('arrivalAddress').value = '';
            document.getElementById('distance').value = '';
            document.getElementById('duration').value = '';
            document.getElementById('passengers').value = '1';
            document.getElementById('courseNotes').value = '';
            document.getElementById('suppNight').checked = false;
            document.getElementById('suppAirport').checked = false;
            document.getElementById('suppWaiting').checked = false;
            document.getElementById('suppBaggage').checked = false;
            document.getElementById('suppToll').checked = false;
            
            // R√©initialiser les coordonn√©es
            departureCoords = null;
            arrivalCoords = null;
            
            calculatePrice();
        }

        function updateDocumentsList() {
            const container = document.getElementById('documentsList');
            
            if (documents.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>Aucun document</h3><p>Cr√©ez votre premi√®re course</p></div>';
                return;
            }

            container.innerHTML = documents.map(doc => `
                <div class="list-item">
                    <div class="list-item-header">
                        <div>
                            <span class="badge ${doc.type === 'devis' ? 'badge-devis' : 'badge-facture'}">
                                ${doc.type.toUpperCase()}
                            </span>
                            <span style="font-weight: 600; color: #3b82f6;">${doc.number}</span>
                        </div>
                        <div class="list-item-title">${doc.client.name}</div>
                    </div>
                    <div class="course-details">
                        <div class="route-info">üìç <strong>D√©part:</strong> ${doc.course.departure}</div>
                        <div class="route-info">üéØ <strong>Arriv√©e:</strong> ${doc.course.arrival}</div>
                        <div style="margin-top: 10px;">
                            üìÖ ${new Date(doc.course.date).toLocaleDateString('fr-FR')} 
                            ${doc.course.time ? 'üïê ' + doc.course.time : ''}
                            | üìè ${doc.course.distance} km 
                            | üë• ${doc.course.passengers} pass.
                        </div>
                    </div>
                    <div style="text-align: right; font-size: 20px; font-weight: 700; color: #1e3a8a; margin: 10px 0;">
                        ${doc.pricing.total.toFixed(2)} ‚Ç¨
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="viewDocument(${doc.id})">üëÅÔ∏è Voir</button>
                        ${doc.type === 'devis' ? `<button class="btn btn-success" onclick="convertToInvoice(${doc.id})">‚úÖ Convertir</button>` : ''}
                        <button class="btn btn-danger" onclick="deleteDocument(${doc.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function viewDocument(id) {
            const doc = documents.find(d => d.id === id);
            if (!doc) return;

            const suppHtml = doc.pricing.supplements.map(s => 
                `<tr><td style="padding: 8px; border: 1px solid #ddd;">${s.name}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${s.amount.toFixed(2)} ‚Ç¨</td></tr>`
            ).join('');

            const html = `<html><head><meta charset="UTF-8"><title>${doc.type.toUpperCase()} ${doc.number}</title>
                <style>body{font-family:Arial;padding:40px;max-width:800px;margin:0 auto;}
                .header{text-align:center;margin-bottom:40px;border-bottom:3px solid #3b82f6;padding-bottom:20px;}
                .section{margin:30px 0;} .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin:20px 0;}
                .info-box{background:#f0f9ff;padding:15px;border-radius:8px;} .info-box h3{color:#1e3a8a;margin-bottom:10px;}
                table{width:100%;border-collapse:collapse;margin:20px 0;}
                th{background:#3b82f6;color:white;padding:12px;text-align:left;}
                td{padding:10px;border:1px solid #ddd;}
                .total{background:#1e3a8a;color:white;font-size:20px;font-weight:bold;padding:15px;text-align:right;margin-top:20px;}
                .route{background:#f0f9ff;padding:20px;border-radius:8px;margin:20px 0;border-left:4px solid #3b82f6;}
                </style></head><body>
                <div class="header">
                    <h1>${doc.type.toUpperCase()}</h1>
                    <h2>${doc.number}</h2>
                    <p>Date: ${new Date(doc.date).toLocaleDateString('fr-FR')}</p>
                </div>
                <div class="info-grid">
                    <div class="info-box">
                        <h3>üöó Chauffeur VTC</h3>
                        <p><strong>${config.companyName || 'Votre entreprise'}</strong><br>
                        ${config.companyAddress || ''}<br>
                        SIRET: ${config.companySiret || 'N/A'}<br>
                        Licence VTC: ${config.companyLicense || 'N/A'}<br>
                        ${config.companyPhone || ''} | ${config.companyEmail || ''}</p>
                    </div>
                    <div class="info-box">
                        <h3>üë§ Passager</h3>
                        <p><strong>${doc.client.name}</strong><br>
                        ${doc.client.company ? doc.client.company + '<br>' : ''}
                        ${doc.client.phone ? 'üìû ' + doc.client.phone + '<br>' : ''}
                        ${doc.client.email ? 'üìß ' + doc.client.email : ''}</p>
                    </div>
                </div>
                <div class="route">
                    <h3 style="color:#1e3a8a;margin-bottom:15px;">üó∫Ô∏è D√©tails de la course</h3>
                    <p><strong>üìÖ Date:</strong> ${new Date(doc.course.date).toLocaleDateString('fr-FR')} 
                    ${doc.course.time ? '√† ' + doc.course.time : ''}</p>
                    <p><strong>üìç D√©part:</strong> ${doc.course.departure}</p>
                    <p><strong>üéØ Destination:</strong> ${doc.course.arrival}</p>
                    <p><strong>üìè Distance:</strong> ${doc.course.distance} km 
                    | <strong>‚è±Ô∏è Dur√©e:</strong> ${doc.course.duration || 'N/A'}
                    | <strong>üë• Passagers:</strong> ${doc.course.passengers}</p>
                    <p><strong>üöò V√©hicule:</strong> ${doc.course.vehicleType}</p>
                    ${doc.course.notes ? '<p><strong>üìù Remarques:</strong> ' + doc.course.notes + '</p>' : ''}
                </div>
                <table>
                    <thead><tr><th>Description</th><th style="text-align:right;">Montant</th></tr></thead>
                    <tbody>
                        <tr><td>Prise en charge</td><td style="text-align:right;">${doc.pricing.basePrice.toFixed(2)} ‚Ç¨</td></tr>
                        <tr><td>Distance (${doc.course.distance} km)</td><td style="text-align:right;">${doc.pricing.distancePrice.toFixed(2)} ‚Ç¨</td></tr>
                        ${suppHtml}
                    </tbody>
                </table>
                <div class="total">TOTAL TTC: ${doc.pricing.total.toFixed(2)} ‚Ç¨</div>
                <p style="text-align:center;margin-top:40px;color:#666;font-size:12px;">
                Merci de votre confiance | ${config.companyName || 'Service VTC professionnel'}</p>
                </body></html>`;

            const newWindow = window.open();
            newWindow.document.write(html);
            newWindow.document.close();
        }

        function convertToInvoice(id) {
            const doc = documents.find(d => d.id === id);
            if (!doc || doc.type !== 'devis') return;

            if (confirm('Convertir ce devis en facture ?')) {
                const invoice = {
                    ...doc,
                    id: Date.now(),
                    type: 'facture',
                    number: doc.number.replace('DEV', 'FACT').replace('Devis', 'Facture'),
                    date: new Date().toISOString().split('T')[0],
                    createdAt: new Date().toISOString()
                };
                documents.push(invoice);
                localStorage.setItem('vtc_documents', JSON.stringify(documents));
                updateDocumentsList();
                alert('Facture cr√©√©e !');
            }
        }

        function deleteDocument(id) {
            if (confirm('Supprimer ce document ?')) {
                documents = documents.filter(d => d.id !== id);
                localStorage.setItem('vtc_documents', JSON.stringify(documents));
                updateDocumentsList();
            }
        }

        function loadConfig() {
            if (config.companyName) document.getElementById('companyName').value = config.companyName;
            if (config.companyAddress) document.getElementById('companyAddress').value = config.companyAddress;
            if (config.companySiret) document.getElementById('companySiret').value = config.companySiret;
            if (config.companyLicense) document.getElementById('companyLicense').value = config.companyLicense;
            if (config.companyPhone) document.getElementById('companyPhone').value = config.companyPhone;
            if (config.companyEmail) document.getElementById('companyEmail').value = config.companyEmail;
            if (config.vehicleBrand) document.getElementById('vehicleBrand').value = config.vehicleBrand;
            if (config.vehiclePlate) document.getElementById('vehiclePlate').value = config.vehiclePlate;
            if (config.vehicleColor) document.getElementById('vehicleColor').value = config.vehicleColor;
            if (config.pricePickup) document.getElementById('pricePickup').value = config.pricePickup;
            if (config.pricePerKm) document.getElementById('pricePerKm').value = config.pricePerKm;
        }

        function saveConfig() {
            config = {
                companyName: document.getElementById('companyName').value,
                companyAddress: document.getElementById('companyAddress').value,
                companySiret: document.getElementById('companySiret').value,
                companyLicense: document.getElementById('companyLicense').value,
                companyPhone: document.getElementById('companyPhone').value,
                companyEmail: document.getElementById('companyEmail').value,
                vehicleBrand: document.getElementById('vehicleBrand').value,
                vehiclePlate: document.getElementById('vehiclePlate').value,
                vehicleColor: document.getElementById('vehicleColor').value,
                pricePickup: parseFloat(document.getElementById('pricePickup').value),
                pricePerKm: parseFloat(document.getElementById('pricePerKm').value)
            };
            localStorage.setItem('vtc_config', JSON.stringify(config));
            alert('Configuration enregistr√©e !');
            calculatePrice();
        }
    </script>
</body>
</html>